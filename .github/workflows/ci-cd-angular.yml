name: Angular CI/CD Workflow

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18.14'

      - name: Verify Node.js version
        run: node -v

      - name: Install Chrome dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
          libnss3 \
          libgconf-2-4 \
          libxss1 \
          libxi6 \
          libgdk-pixbuf2.0-0 \
          libgtk-3-0 \
          xvfb \
          fonts-liberation \
          libappindicator3-1 \
          libasound2 \
          google-chrome-stable

      - name: Install dependencies
        run: npm install

      - name: Run Angular tests
        run: npm run test -- --watch=false || true

      - name: Build Angular project
        run: npm run build -- --configuration production

      - name: List project files for debugging
        run: ls -R

      - name: Run TestCafe tests
        env:
          DISPLAY: ':99.0'
        run: |
          Xvfb :99 -screen 0 1920x1080x16 &
          npx testcafe "chrome:headless --no-sandbox --disable-dev-shm-usage" e2e/tests/test1.js --debug-on-fail

  deploy:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to hosting service
        run: echo "Despliegue"
